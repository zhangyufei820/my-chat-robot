<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gemini AI 工作站</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;800&display=swap');
:root{
  --deep:#0d0f1a;--panel:#181b2e;--border:#3a3e6e;
  --c1:#9d8eee;--c2:#00bfff;--txt:#f0f0f5;--txt2:#bfbfe7;
  --user-bubble:#3a3f65; --ai-bubble:#2a2d42;
}
*{box-sizing:border-box;margin:0}
body{font-family:'Exo 2','Noto Sans SC',sans-serif;background:var(--deep);color:var(--txt);height:100vh;display:flex;overflow:hidden;}
#sidebar{width:300px;padding:32px 16px;display:flex;flex-direction:column;gap:16px;border-right:1px solid 
var(--border);overflow-y:auto;background:var(--deep)}
#chat-wrapper{flex:1;display:flex;flex-direction:column;background:var(--panel)}

/* ==================== 方案2: 视觉升级 ==================== */

/* 1. 角色卡片优化 */
.persona-card{
  background: #1f223a; border: 1px solid transparent; border-left: 4px solid transparent;
  border-radius:10px; padding:18px 16px; cursor:pointer; transition: all .3s ease;
  user-select:none; font-size:1rem; font-weight:600; line-height:1.4; color:var(--txt2);
  display: flex; align-items: center; gap: 14px;
}
.persona-card .icon{width:24px;height:24px;fill:var(--txt2);transition: all .3s ease;}
.persona-card:hover{
  transform:translateX(5px); background:#282b48; color:#fff;
}
.persona-card:hover .icon {fill:#fff;}
.persona-card.active{
  color:#fff; background:linear-gradient(90deg, #2a2d42, #1f223a);
  border-left: 4px solid var(--c1); box-shadow:0 4px 12px rgba(0,0,0,.3);
}
.persona-card.active .icon {fill: var(--c1);}

/* 2. 聊天区 & 消息气泡优化 */
#chat-box{flex:1;padding:28px;overflow-y:auto;display:flex;flex-direction:column;gap:24px}
.message{display:flex;max-width:85%;animation:fadeIn .4s; align-items:flex-end; gap:12px;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* 头像样式 */
.avatar{
  width:36px; height:36px; border-radius:50%; background:var(--deep);
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
  border: 1px solid var(--border);
}
.avatar svg{width:20px;height:20px;fill:var(--txt2);}

.message-bubble{
  padding:14px 20px; border-radius:18px; line-height:1.6;
  white-space:pre-wrap; word-break:break-word;
}

/* AI消息 (左侧) */
.ai-message{align-self:flex-start;}
.ai-message .message-bubble{background:var(--ai-bubble);color:var(--txt2); border-bottom-left-radius: 4px;}

/* 用户消息 (右侧) - 核心改动 */
.user-message{align-self:flex-end; flex-direction:row-reverse;} /* flex-direction 来交换头像和气泡位置 */
.user-message .avatar svg{fill:var(--c1);}
.user-message .message-bubble{background:var(--user-bubble);color:#fff; border-bottom-right-radius: 4px;}

/* 正在输入动画 */
.loading .message-bubble{padding: 20px;}
.loading .dot-flashing {position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: var(--txt2); color: var(--txt2); 
animation: dot-flashing 1s infinite linear alternate; animation-delay: .5s;}
.loading .dot-flashing::before, .loading .dot-flashing::after {content: ''; display: inline-block; position: absolute; top: 0;}
.loading .dot-flashing::before {left: -12px; width: 6px; height: 6px; border-radius: 5px; background-color: var(--txt2); color: var(--txt2); 
animation: dot-flashing 1s infinite alternate; animation-delay: 0s;}
.loading .dot-flashing::after {left: 12px; width: 6px; height: 6px; border-radius: 5px; background-color: var(--txt2); color: var(--txt2); 
animation: dot-flashing 1s infinite alternate; animation-delay: 1s;}
@keyframes dot-flashing {0% {background-color: var(--txt2);} 50%, 100% {background-color: rgba(191, 191, 231, 0.3);}}


/* 3. 输入区优化 */
#input-area{
  padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;
  background:rgba(14,16,26,.9);backdrop-filter:blur(12px);transition: border-color .3s ease;
}
#input-area:focus-within{border-top-color: var(--c1);}
#message-input{
  flex:1;background:var(--deep);border:1px solid var(--border);border-radius:22px;
  padding:10px 18px;font-size:1rem;color:var(--txt);outline:none;transition: border-color .3s, box-shadow .3s;
}
#message-input:focus{border-color:var(--c1);box-shadow:0 0 8px rgba(157,142,238,.5)}
#send-button{
  width:46px;height:46px;border:none;border-radius:50%;background:linear-gradient(135deg,var(--c1),var(--c2));
  cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;box-shadow:0 0 12px rgba(157,142,238,.5); 
flex-shrink:0;
}
#send-button:hover{transform:scale(1.1);box-shadow:0 0 18px rgba(0,191,255,.75)}
#send-button svg{fill:#fff;width:22px;height:22px}
@media(max-width:768px){ #sidebar{display:none}}
</style>
</head>

<body>
  <div id="sidebar"></div>

  <div id="chat-wrapper">
    <div id="chat-box">
       </div>
    <div id="input-area">
      <input id="message-input" type="text" placeholder="请先选择角色..." />
      <button id="send-button" title="发送">
        <svg viewBox="0 0 24 24"><path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

<script>
const API_ROOT = location.origin;
const chatBox = document.getElementById('chat-box');
const input = document.getElementById('message-input');
const sendBtn = document.getElementById('send-button');
const sidebar = document.getElementById('sidebar');

// SVG 图标模板
const ICONS = {
  persona: `<svg viewBox="0 0 24 24"><path d="M14.25 2.27c.45.13.88.3.128.5l.48.83c.18.32.28.68.28 
1.05V6h-2.5V4.65c0-.9-.75-1.65-1.65-1.65-.37 0-.72.12-1.01.32l-.5.33c-.45.3-.98.5-1.53.5-1.32 0-2.39-1.07-2.39-2.39S4.68.11 6 .11c.37 0 
.74.08 1.08.23l.33.15c.98.44 2.1.44 3.08 0l.33-.15c.42-.19.89-.28 1.37-.28.32 0 .63.05.93.14Z M21.41 14.29l-2.44-2.44c-.39-.39-.39-1.02 
0-1.41l2.44-2.44c.39-.39 1.02-.39 1.41 0l.17.17c.39.39.39 1.02 0 1.41l-2.44 2.44c-.39.39-.39 1.02 0 1.41l2.44 2.44c.39.39.39 1.02 0 
1.41l-.17.17c-.39.39-1.02.39-1.41 0ZM15 22H9c-5 0-7-2-7-7V9c0-5 2-7 7-7h6c5 0 7 2 7 7v6c0 5-2 7-7 7Z"/></svg>`,
  ai: `<svg viewBox="0 0 24 24"><path d="M19.32 9.47a1.69 1.69 0 0 0-1.2-2.85 1.68 1.68 0 0 0-1.35.61 1.65 1.65 0 0 0-2.65-.21 1.65 1.65 0 0 
0-1.28-1.74A1.68 1.68 0 0 0 11 6.8a1.65 1.65 0 0 0-1.35-.61 1.69 1.69 0 0 0-1.2-2.85 1.69 1.69 0 0 0-1.63 1.69c0 .4.16.78.43 1.06a1.65 1.65 0 
0 0 2.65.21 1.65 1.65 0 0 0 1.28 1.74 1.68 1.68 0 0 0 1.83-1.53 1.65 1.65 0 0 0 1.35.61c.49 0 .95-.21 1.28-.58.33-.37.52-.85.52-1.36Z M19.32 
14.53a1.69 1.69 0 0 0 1.63 1.69c.94 0 1.69-.76 1.69-1.69 0-.4-.16-.78-.43-1.06a1.65 1.65 0 0 0-2.65-.21 1.65 1.65 0 0 0-1.28-1.74 1.68 1.68 0 
0 0-1.83 1.53 1.65 1.65 0 0 0-1.35.61c-.49 0-.95-.21-1.28-.58-.33-.37-.52-.85-.52-1.36a1.69 1.69 0 0 0-1.69-1.69 1.69 1.69 0 0 0-1.2 2.85 
1.68 1.68 0 0 0 1.35-.61 1.65 1.65 0 0 0 2.65.21 1.65 1.65 0 0 0 1.28 1.74 1.68 1.68 0 0 0 1.83-1.53c0 .51.19.99.52 1.36.33.37.79.58 
1.28.58Z"/></svg>`,
  user: `<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 
4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`
};

let currentPersona = '';

/* ---------- 角色加载 ---------- */
async function loadPersonas(){
  try{
    const res = await fetch(`${API_ROOT}/get-personas`);
    const personas = await res.json();
    sidebar.innerHTML='';
    Object.entries(personas).forEach(([key,name])=>{
      const card = document.createElement('div');
      card.className='persona-card';
      // 使用 innerHTML 来添加图标和文字
      card.innerHTML = `<div class="icon">${ICONS.persona}</div><span class="name">${name}</span>`;
      card.onclick=()=>selectPersona(key,card, name);
      sidebar.appendChild(card);
    });
  }catch(err){
    sidebar.innerHTML='<p style="color:red">角色加载失败</p>';
  }
}

/* ---------- 选择角色 ---------- */
function selectPersona(key, card, name){
  currentPersona = key;
  input.placeholder = `以【${name}】身份聊天…`;
  document.querySelectorAll('.persona-card').forEach(c=>c.classList.remove('active'));
  card.classList.add('active');
  // 清空聊天并显示新的欢迎语
  chatBox.innerHTML = '';
  addMessage(`你好！我是${name}，现在可以开始聊天了。`, 'ai');
}

/* ---------- 添加消息到DOM (已重构) ---------- */
function addMessage(text, type){
  const msg = document.createElement('div');
  msg.className = `message ${type}-message`;

  // 创建头像
  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.innerHTML = ICONS[type] || '';
  
  // 创建消息气泡
  const bubble = document.createElement('div');
  bubble.className = 'message-bubble';

  // 处理正在加载的动画
  if (type === 'ai' && text === '...') {
    msg.classList.add('loading');
    bubble.innerHTML = '<div class="dot-flashing"></div>';
  } else {
    bubble.textContent = text;
  }
  
  // 按照 AI（左）和用户（右）的顺序添加头像和气泡
  // CSS中的 flex-direction: row-reverse 会处理用户消息的顺序
  msg.appendChild(avatar);
  msg.appendChild(bubble);
  
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
  return msg;
}

/* ---------- 发送消息 ---------- */
async function sendMessage(){
  const text = input.value.trim();
  if(!text||!currentPersona){
    input.placeholder = "请务必先从左侧选择一个角色!";
    return;
  }
  addMessage(text, 'user');
  const loading = addMessage('...', 'ai');
  input.value='';

  try{
    const res = await fetch(`${API_ROOT}/chat`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:text,persona:currentPersona})
    });
    const data = await res.json();
    updateMessage(loading, data.reply||data.error||'出错了');
  }catch(err){
    updateMessage(loading,'网络错误，请稍后再试');
  }
}

/* ---------- 更新AI消息 (已重构) ---------- */
function updateMessage(el, newText){
  el.classList.remove('loading');
  const bubble = el.querySelector('.message-bubble');
  if (bubble) {
    bubble.innerHTML = ''; // 清除加载动画
    bubble.textContent = newText;
  }
}

/* ---------- 事件监听与启动 ---------- */
sendBtn.onclick = sendMessage;
input.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}});

// 启动
loadPersonas();
addMessage('你好！请先从左侧选择一个角色，然后开始聊天。', 'ai');
</script>
</body>
</html>
