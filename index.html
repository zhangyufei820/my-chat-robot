<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gemini AI 工作站</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
:root {
  --bg-deep: #121212;
  --bg-panel: #1E1E1E;
  --bg-card: #2A2A2A;
  --bg-card-hover: #3c3c3c;
  --border-color: #333;
  --accent-primary: #00A9FF;
  --accent-glow: rgba(0, 169, 255, 0.5);
  --text-primary: #EAEAEA;
  --text-secondary: #B0B0B0;
  --user-bubble: #005c8a;
  --ai-bubble: #2c2c2e;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { font-size: 16px; }

body {
  font-family: 'Noto Sans SC', sans-serif;
  background: var(--bg-deep);
  color: var(--text-primary);
  height: 100vh;
  width: 100vw;
  display: flex;
  overflow: hidden;
  transition: transform 0.3s ease-in-out;
}

#sidebar {
  width: 300px;
  background: var(--bg-deep);
  border-right: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  padding: 1rem;
  gap: 0.75rem;
  overflow-y: auto;
  transition: transform 0.3s ease-in-out;
  flex-shrink: 0;
}

.persona-card {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-left: 4px solid transparent;
  border-radius: 8px;
  padding: 1rem;
  cursor: pointer;
  user-select: none;
  font-size: 0.95rem;
  font-weight: 500;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 1rem;
  transition: all 0.2s ease;
}
.persona-card:hover {
  background: var(--bg-card-hover);
  color: var(--text-primary);
  transform: translateX(4px);
}
.persona-card.active {
  color: var(--text-primary);
  background: var(--bg-panel);
  border-left: 4px solid var(--accent-primary);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}
.persona-card .icon {
  width: 24px;
  height: 24px;
  fill: var(--text-secondary);
  transition: fill 0.2s ease;
  flex-shrink: 0;
}
.persona-card:hover .icon, .persona-card.active .icon { fill: var(--accent-primary); }


#chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--bg-panel);
  height: 100vh;
}

#chat-header {
  display: flex;
  align-items: center;
  padding: 0 1.5rem;
  height: 60px;
  border-bottom: 1px solid var(--border-color);
  background: rgba(30, 30, 30, 0.8);
  backdrop-filter: blur(10px);
  flex-shrink: 0;
}
#menu-button {
  display: none; /* Hidden on desktop */
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.5rem;
}
#menu-button svg { width: 24px; height: 24px; fill: var(--text-secondary); }
#current-persona-name {
  font-size: 1.1rem;
  font-weight: 600;
  margin-left: 1rem;
}

#chat-box {
  flex: 1;
  padding: 2rem;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}
.message {
  display: flex;
  max-width: 80%;
  animation: message-fade-in 0.4s ease-out;
  align-items: flex-end;
  gap: 0.75rem;
}
@keyframes message-fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.avatar {
  width: 40px; height: 40px; border-radius: 50%;
  background: var(--bg-deep);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; border: 1px solid var(--border-color);
}
.avatar svg { width: 22px; height: 22px; fill: var(--text-secondary); }

.message-bubble {
  padding: 0.8rem 1.2rem;
  border-radius: 18px;
  line-height: 1.6;
  font-size: 1rem;
  white-space: pre-wrap;
  word-break: break-word;
}
.ai-message { align-self: flex-start; }
.ai-message .message-bubble { background: var(--ai-bubble); color: var(--text-primary); border-bottom-left-radius: 5px; }
.user-message { align-self: flex-end; flex-direction: row-reverse; }
.user-message .avatar svg { fill: var(--accent-primary); }
.user-message .message-bubble { background: var(--user-bubble); color: #fff; border-bottom-right-radius: 5px; }

.loading .dot-flashing { position: relative; width: 8px; height: 8px; border-radius: 5px; background-color: var(--text-secondary); color: 
var(--text-secondary); animation: dot-flashing 1s infinite linear alternate; animation-delay: .5s; }
.loading .dot-flashing::before, .loading .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; }
.loading .dot-flashing::before { left: -15px; width: 8px; height: 8px; border-radius: 5px; background-color: var(--text-secondary); 
color: var(--text-secondary); animation: dot-flashing 1s infinite alternate; animation-delay: 0s; }
.loading .dot-flashing::after { left: 15px; width: 8px; height: 8px; border-radius: 5px; background-color: var(--text-secondary); color: 
var(--text-secondary); animation: dot-flashing 1s infinite alternate; animation-delay: 1s; }
@keyframes dot-flashing { 0% { background-color: var(--text-secondary); } 50%, 100% { background-color: rgba(176, 176, 176, 0.3); } }

#input-area {
  padding: 1rem 1.5rem;
  border-top: 1px solid var(--border-color);
  display: flex; gap: 1rem; align-items: center;
  background: var(--bg-panel);
}
#message-input {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 24px;
  padding: 12px 20px;
  font-size: 1rem;
  color: var(--text-primary);
  outline: none;
  transition: all 0.2s ease;
  font-family: 'Noto Sans SC', sans-serif;
}
#message-input:focus { border-color: var(--accent-primary); box-shadow: 0 0 10px var(--accent-glow); }
#send-button {
  width: 48px; height: 48px; border: none; border-radius: 50%;
  background: var(--accent-primary);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.2s ease;
  flex-shrink: 0;
}
#send-button:hover { transform: scale(1.1); box-shadow: 0 0 12px var(--accent-glow); }
#send-button svg { fill: #fff; width: 24px; height: 24px; }

#overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 99;
}

/* 移动端适配 */
@media (max-width: 768px) {
  #sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    z-index: 100;
    transform: translateX(-100%);
    border-right: 1px solid var(--border-color);
  }
  body.sidebar-open #sidebar {
    transform: translateX(0);
  }
  body.sidebar-open #overlay {
    display: block;
  }
  #menu-button {
    display: block;
  }
}
</style>
</head>
<body>
  <div id="sidebar"></div>
  <div id="overlay"></div>
  <div id="chat-container">
    <header id="chat-header">
        <button id="menu-button">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        <div id="current-persona-name">欢迎使用</div>
    </header>
    <div id="chat-box"></div>
    <div id="input-area">
      <input id="message-input" type="text" placeholder="请先从左侧选择一个角色..." />
      <button id="send-button" title="发送">
        <svg viewBox="0 0 24 24"><path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

<script>
console.log("--- SCRIPT STARTED ---");
const API_ROOT = location.origin;
const chatBox = document.getElementById('chat-box');
const input = document.getElementById('message-input');
const sendBtn = document.getElementById('send-button');
const sidebar = document.getElementById('sidebar');
const menuButton = document.getElementById('menu-button');
const overlay = document.getElementById('overlay');
const currentPersonaName = document.getElementById('current-persona-name');

let currentPersona = '';
let chatHistory = []; // 1. 全局变量，用于存储上下文

const ICONS = { /* SVG图标内容保持不变 */ };

// --- 移动端菜单逻辑 ---
menuButton.addEventListener('click', () => document.body.classList.add('sidebar-open'));
overlay.addEventListener('click', () => document.body.classList.remove('sidebar-open'));

async function loadPersonas() { /* 函数内容保持不变 */ }

function selectPersona(key, card, name) {
  currentPersona = key;
  input.placeholder = `与 ${name} 对话...`;
  currentPersonaName.textContent = name;
  document.querySelectorAll('.persona-card').forEach(c => c.classList.remove('active'));
  card.classList.add('active');
  
  chatBox.innerHTML = '';
  chatHistory = []; // 2. 切换角色时，清空历史记录
  
  addMessage(`你好！我是${name}，现在可以开始聊天了。`, 'ai');
  
  // 在移动端，选择后自动关闭侧边栏
  document.body.classList.remove('sidebar-open');
}

function addMessage(text, type) {
  const msg = document.createElement('div');
  msg.className = `message ${type}-message`;
  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.innerHTML = ICONS[type === 'user' ? 'user' : 'ai'] || '';
  const bubble = document.createElement('div');
  bubble.className = 'message-bubble';
  if (type === 'ai' && text === '...') {
    msg.classList.add('loading');
    bubble.innerHTML = '<div class="dot-flashing"></div>';
  } else {
    bubble.textContent = text;
  }
  msg.appendChild(avatar);
  msg.appendChild(bubble);
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
  
  // 3. 将新消息添加到历史记录
  const role = (type === 'user') ? 'user' : 'model';
  chatHistory.push({ role: role, parts: [{ text: text }] });
  
  return msg;
}

function updateMessage(el, newText) {
  el.classList.remove('loading');
  const bubble = el.querySelector('.message-bubble');
  if (bubble) {
    bubble.innerHTML = '';
    bubble.textContent = newText;
  }
  
  // 4. 更新历史记录中的最后一条AI消息
  const lastMessage = chatHistory[chatHistory.length - 1];
  if (lastMessage && lastMessage.role === 'model') {
    lastMessage.parts[0].text = newText;
  }
}

async function sendMessage() {
  const text = input.value.trim();
  if (!text || !currentPersona) {
    input.placeholder = !currentPersona ? "请先选择一个角色!" : "消息不能为空!";
    return;
  }
  
  addMessage(text, 'user');
  const loading = addMessage('...', 'ai');
  input.value = '';

  try {
    // 5. 发送包含历史记录的请求
    const res = await fetch(`${API_ROOT}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: text,
        persona: currentPersona,
        history: chatHistory.slice(0, -2) // 发送除最后两条（用户新消息和AI加载中）之外的历史
      })
    });
    const data = await res.json();
    if (res.ok) {
        updateMessage(loading, data.reply);
    } else {
        updateMessage(loading, data.error || '发生未知错误');
    }
  } catch (err) {
    updateMessage(loading, '网络连接失败，请稍后再试');
  }
}

sendBtn.onclick = sendMessage;
input.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

// 启动
loadPersonas();

// 复制一份ICONS内容，因为上面折叠了
const ICONS_data = {
  persona: `<svg viewBox="0 0 24 24"><path d="M14.25 2.27c.45.13.88.3 1.28.5l.48.83c.18.32.28.68.28 
1.05V6h-2.5V4.65c0-.9-.75-1.65-1.65-1.65-.37 0-.72.12-1.01.32l-.5.33c-.45.3-.98.5-1.53.5-1.32 0-2.39-1.07-2.39-2.39S4.68.11 6 .11c.37 0 
.74.08 1.08.23l.33.15c.98.44 2.1.44 3.08 0l.33-.15c.42-.19.89-.28 1.37-.28.32 0 .63.05.93.14Z M21.41 14.29l-2.44-2.44c-.39-.39-.39-1.02 
0-1.41l2.44-2.44c.39-.39 1.02-.39 1.41 0l.17.17c.39.39.39 1.02 0 1.41l-2.44 2.44c-.39-.39-.39 1.02 0 1.41l2.44 2.44c.39.39.39 1.02 0 
1.41l-.17.17c-.39-.39-1.02.39-1.41 0ZM15 22H9c-5 0-7-2-7-7V9c0-5 2-7 7-7h6c5 0 7 2 7 7v6c0 5-2 7-7 7Z"/></svg>`,
  ai: `<svg viewBox="0 0 24 24"><path d="M19.32 9.47a1.69 1.69 0 0 0-1.2-2.85 1.68 1.68 0 0 0-1.35.61 1.65 1.65 0 0 0-2.65-.21 1.65 1.65 
0 0 0-1.28-1.74A1.68 1.68 0 0 0 11 6.8a1.65 1.65 0 0 0-1.35-.61 1.69 1.69 0 0 0-1.2-2.85 1.69 1.69 0 0 0-1.63 1.69c0 .4.16.78.43 
1.06a1.65 1.65 0 0 0 2.65.21 1.65 1.65 0 0 0 1.28 1.74 1.68 1.68 0 0 0 1.83-1.53 1.65 1.65 0 0 0 1.35.61c.49 0 .95-.21 
1.28-.58.33-.37.52-.85.52-1.36Z M19.32 14.53a1.69 1.69 0 0 0 1.63 1.69c.94 0 1.69-.76 1.69-1.69 0-.4-.16-.78-.43-1.06a1.65 1.65 0 0 
0-2.65-.21 1.65 1.65 0 0 0-1.28-1.74 1.68 1.68 0 0 0-1.83 1.53 1.65 1.65 0 0 0-1.35.61c-.49 
0-.95-.21-1.28-.58-.33-.37-.52-.85-.52-1.36a1.69 1.69 0 0 0-1.69-1.69 1.69 1.69 0 0 0-1.2 2.85 1.68 1.68 0 0 0 1.35-.61 1.65 1.65 0 0 0 
2.65.21 1.65 1.65 0 0 0 1.28 1.74 1.68 1.68 0 0 0 1.83-1.53c0 .51.19.99.52 1.36.33.37.79.58 1.28.58Z"/></svg>`,
  user: `<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 
4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`
};
Object.assign(ICONS, ICONS_data);
</script>
</body>
</html>
